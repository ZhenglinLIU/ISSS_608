---
title: "Take-home Exercise 3"
description: |
  A new article created using the Distill format.
author:
  - name: LIU Zhenglin 
    url: https://www.linkedin.com/in/zhenglin-liu-a86aa5219/
    affiliation: SMU SCIS
    affiliation_url: https://scis.smu.edu.sg/
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE)
```


# Import packages and data

```{r}
packages = c('tidyverse','skimr','ggrepel','patchwork',
             'lubridate', 'trelliscopejs', 'zoo',
             'DT', 'tidyr', 'gganimate', 'gifski', 
             'gapminder', 'ggridges','ggiraph')

for(p in packages){
  if(!require(p, character.only =T)){
    install.packages(p)
    }
  library(p, character.only =T)
}
```

### Importing Data

```{r}
fj <- read_csv("E:/data/Journals/FinancialJournal.csv")
fj
fj %>% 
  filter(participantId == 0)
```


We can see there are 4 columns in Financial Journal Dataset:
● participantId (integer): unique ID corresponding to the participant affected
● timestamp (datetime): the time when the check-in was logged
● category (string factor): a string describing the expense category, one of{“Education”, “Food”, “Recreation”, “RentAdjustment”, “Shelter”, “Wage”}
● amount (double): the amount of the transaction
1. As for the category column, it contains 6 different kind of financial factors, split this column in to 6 different columns which shows one of these factors can help us to summarize and analyze the financial situation of participants, so this is the first task of our data wrangling. 
2. This dataset contains nearly 2 million rows, one participant have 1958 rows to present his or her financial situation, as for analysis, the timestamp is too large, so we need to set a time interval for better analysis, we choose one month as the time interval. 


# Data Wrangling for Financial Journal. 

### 1. Time interval

```{r}
fj_t <- fj %>% 
  mutate(yearmonth = format(as.Date(timestamp), "%Y.%m"))
fj_t
```
```{r}
fj_t %>% 
  filter(participantId == 0) %>% 
  filter(category == "Education")
```

### Pivot Original Dataframe 

Before pivot the financial journal, we need to calculate the monthly financial situation for each participant in each cost or revenue area. For dealing with this problem, we need to combine [**group_by**](https://dplyr.tidyverse.org/reference/group_by.html) and [**summarise**](https://dplyr.tidyverse.org/reference/summarise.html) functions to realize our aim. 

```{r}
fj_c <- fj_t %>% 
  group_by(participantId, category, yearmonth) %>% 
  summarise(monthly_financial = sum(amount))
fj_c
```

```{r}
fj_p <- fj_c %>% 
  pivot_wider(names_from = category, values_from = monthly_financial)
fj_p[is.na(fj_p)] = 0
fj_p
```


```{r}
fj_p <- fj_p %>% 
  mutate(monthly_cost = Education + Food + Recreation + Shelter) %>% 
  mutate(monthly_revenue = Wage + RentAdjustment) %>% 
  mutate(monthly_balance = monthly_revenue + monthly_cost)
fj_p
```
```{r}
part <- read_csv("E:/data/Attributes/Participants.csv")
```

```{r}
fj_join <- fj_p %>% 
  left_join(part, by = "participantId")
fj_join
```

```{r}
ggplot(fj_p, aes(x=Wage, y=fj_p$yearmonth, fill = factor(stat(quantile)))) +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis_d(name = "Quartiles")
```

```{r}
ggplot(fj_join, aes(x = Wage, y = fj_join$yearmonth, fill = 0.5 - abs(0.5 - stat(ecdf)))) +
  stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail probability", direction = -1)
```

```{r}
ggplot(fj_join, aes(x = fj_join$monthly_balance, y = fj_join$interestGroup, fill = 0.5 - abs(0.5 - stat(ecdf)))) +
  stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail probability", direction = -1) 
```

```{r monthly cost rate according to education level}
tooltip <- function(y, ymax, accuracy = .0001) {
  mean <- scales::number(y, accuracy = accuracy)
  sem <- scales::number(ymax - y, accuracy = accuracy)
  paste("Mean cost rate:", mean, "+/-", sem)
} 
gg_point <- ggplot(data=fj_join, 
                   aes(x = fj_join$educationLevel),
) +
  stat_summary(aes(y = abs(fj_join$monthly_cost)/fj_join$monthly_revenue, 
                   tooltip = after_stat(
                     tooltip(y, ymax))),
    fun.data = "mean_se", 
    geom = GeomInteractiveCol,
    fill = "light blue"
  ) +
  stat_summary(aes(y = abs(fj_join$monthly_cost)/fj_join$monthly_revenue),
    fun.data = mean_se,
    geom = "errorbar", width = 0.2, size = 0.2
  )
girafe(ggobj = gg_point,
       width_svg = 8,
       height_svg = 8*0.618)
```



